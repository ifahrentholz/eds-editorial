{"version":3,"file":"createOptimizedPicture.VF-L56J3.js","sources":["../../src/services/fetch.service.ts","../../src/utils/getWindowLocation.ts","../../src/utils/createOptimizedPicture.ts"],"sourcesContent":["class FetchService {\n  private responseMap = new Map<string, Promise<Response>>();\n\n  private async fetchData(endpoint: string, init?: RequestInit): Promise<Response> {\n    const url = this.getUrl(endpoint);\n\n    if (this.responseMap.has(url)) return this.responseMap.get(url)!;\n\n    const fetchPromise = fetch(url, init);\n\n    this.responseMap.set(url, fetchPromise);\n\n    const response = await fetchPromise;\n\n    if (response.ok) return response;\n\n    //TODO: Use DebugService in future\n    console.error(response.statusText);\n    this.responseMap.delete(url);\n    return response;\n  }\n\n  public async fetchJson<T>(endpoint: string, init?: RequestInit): Promise<T> {\n    const response = await this.fetchData(endpoint, init);\n    return await response.clone().json();\n  }\n\n  public async fetchText(endpoint: string, init?: RequestInit): Promise<string> {\n    const response = await this.fetchData(endpoint, init);\n    return response.clone().text();\n  }\n\n  private getUrl(endpoint: string) {\n    const decoratedEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;\n    return `${window.hlx.codeBasePath}${decoratedEndpoint}`;\n  }\n}\n\nexport default new FetchService();\n","/**\n * Returns the true origin of the current page in the browser.\n * If the page is running in an iframe with srcdoc, the ancestor origin is returned.\n * @returns {String} The true origin\n */\nexport function getOrigin(): string {\n  const { location } = window;\n  return location.href === 'about:srcdoc' ? window.parent.location.origin : location.origin;\n}\n\n/**\n * Returns the true origin of the current page in the browser.\n * If the page is running in an iframe with srcdoc, the ancestor origin + the path query param is returned.\n * @returns {String} The href of the current page or the href of the block running in the library\n */\nexport function getHref(): string {\n  if (window.location.href !== 'about:srcdoc') return window.location.href;\n\n  const { location: parentLocation } = window.parent;\n  const urlParams = new URLSearchParams(parentLocation.search);\n  return `${parentLocation.origin}${urlParams.get('path')}`;\n}\n\n/**\n * Returns the true origin of the current page in the browser.\n * If the page is running in an iframe with srcdoc, the query param is returned.\n * @returns {String} The query param of the current page or the query param of the block running in the library\n */\nexport function getLocation(): Location {\n  const { location } = window;\n  return location.href === 'about:srcdoc' ? window.parent.location : location;\n}\n","/**\n * Returns a picture element with webp and fallbacks\n * @param {string} src The image URL\n * @param {string} [alt] The image alternative text\n * @param {boolean} [eager] Set loading attribute to eager\n * @param {Array} [breakpoints] Breakpoints and corresponding params (eg. width)\n * @returns {Element} The picture element\n */\n\nimport { getHref } from './getWindowLocation';\n\ninterface CreateOptimizedPictureArgs {\n  src: string;\n  alt: string;\n  width: string;\n  height: string;\n  eager?: boolean;\n  breakpoints?: Array<Record<string, string>>;\n}\n\nexport function createOptimizedPicture(args: CreateOptimizedPictureArgs): HTMLPictureElement {\n  const {\n    src,\n    alt,\n    eager = false,\n    width,\n    height,\n    breakpoints = [{ media: '(min-width: 600px)', width: '2000' }, { width: '750' }],\n  } = args;\n  const url = new URL(src, getHref());\n  const picture = document.createElement('picture');\n  const { pathname } = url;\n  const ext = pathname.substring(pathname.lastIndexOf('.') + 1);\n\n  // webp\n  breakpoints.forEach((br) => {\n    const source = document.createElement('source');\n    if (br.media) source.setAttribute('media', br.media);\n    source.setAttribute('type', 'image/webp');\n    source.setAttribute('srcset', `${pathname}?width=${br.width}&format=webply&optimize=medium`);\n    picture.appendChild(source);\n  });\n\n  // fallback\n  breakpoints.forEach((br, i) => {\n    if (i < breakpoints.length - 1) {\n      const source = document.createElement('source');\n      if (br.media) source.setAttribute('media', br.media);\n      source.setAttribute('srcset', `${pathname}?width=${br.width}&format=${ext}&optimize=medium`);\n      picture.appendChild(source);\n    } else {\n      const img = document.createElement('img');\n      img.setAttribute('loading', eager ? 'eager' : 'lazy');\n      img.setAttribute('alt', alt);\n      img.setAttribute('width', width);\n      img.setAttribute('height', height);\n      picture.appendChild(img);\n      img.setAttribute('src', `${pathname}?width=${br.width}&format=${ext}&optimize=medium`);\n    }\n  });\n\n  return picture;\n}\n"],"names":["FetchService","endpoint","init","url","fetchPromise","response","decoratedEndpoint","FetchService$1","getHref","parentLocation","urlParams","getLocation","location","createOptimizedPicture","args","src","alt","eager","width","height","breakpoints","picture","pathname","ext","br","source","i","img"],"mappings":"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"}