{"version":3,"file":"posts.js","sources":["../../src/blocks/posts/posts.ts"],"sourcesContent":["import { html, nothing, render } from 'lit';\nimport { createOptimizedPicture } from 'Utils/createOptimizedPicture.ts';\nimport FetchService from '../../services/fetch.service.ts';\nimport { ifDefined } from 'lit-html/directives/if-defined.js';\nimport './posts.scss';\nimport PlaceholderService from 'Services/placeholder.service.ts';\nimport { SheetsResponse } from 'Types/sheetResponse.types.ts';\nimport { isSidekickLibraryActive } from 'Helpers/sidekick/isSidekickLibraryActive.ts';\nimport { DebuggerService } from '@kluntje/services';\nimport { SiteMapEntry } from 'Types/siteMap.types.ts';\ninterface PostArgs {\n  postUrl?: string;\n  headline?: string;\n  text?: string;\n  picture?: HTMLPictureElement;\n  buttontext?: string;\n}\n\nconst renderHeadline = (headline?: string) => {\n  if (!headline) return nothing;\n  return html`<h3>${headline}</h3>`;\n};\n\nconst renderText = (text?: string) => {\n  if (!text) return nothing;\n  if (text.length > 200) {\n    return html`<p>${text.slice(0, 200)}...</p>`;\n  }\n  return html`<p>${text}</p>`;\n};\n\nconst renderPicture = (postUrl?: string, picture?: HTMLPictureElement) => {\n  if (!picture) return nothing;\n  return html`<a href=\"${ifDefined(postUrl)}\" class=\"image\">${picture}</a>`;\n};\n\nconst postTemplate = (args: PostArgs) => {\n  const { postUrl, headline, text, picture, buttontext } = args;\n  return html`\n    <article>\n      ${renderPicture(postUrl, picture)} ${renderHeadline(headline)} ${renderText(text)}\n      <ul class=\"actions\">\n        <li><a href=\"${ifDefined(postUrl)}\" class=\"button\">${buttontext || 'Goto Post'}</a></li>\n      </ul>\n    </article>\n  `;\n};\n\nconst template = async (posts: PostArgs[]) => {\n  if (posts.length === 0) {\n    const placeholder = await PlaceholderService.getPlaceHolder('no posts');\n    return html` <article>${placeholder}</article> `;\n  }\n  return posts.map((post) => postTemplate(post));\n};\n\n// TODO: Candidate for a EDS helper function???\nconst findFirstNonEmptyParagraph = (doc: Document): string | undefined => {\n  const paragraphs = Array.from(doc.querySelectorAll('p'));\n  return paragraphs.find((p) => p.innerText.trim().length > 0)?.innerText;\n};\n\nfunction fetchPost(post: SiteMapEntry) {\n  try {\n    return FetchService.fetchText(`${post.path}.plain.html`, {\n      cacheOptions: {\n        cacheType: 'runtime',\n      },\n    });\n  } catch (error) {\n    DebuggerService.error(`Post Block: Error while fetching ${post.path}.plain.html`, error);\n    return;\n  }\n}\n\nfunction createPostEntry(siteMapPostEntries: SiteMapEntry[], index: number, doc: Document) {\n  return {\n    postUrl: isSidekickLibraryActive() ? undefined : `${window.hlx.codeBasePath}${siteMapPostEntries[index].path}`,\n    headline: doc.querySelector('h1')?.innerText || doc.querySelector('h2')?.innerText,\n    text: findFirstNonEmptyParagraph(doc),\n    buttontext: siteMapPostEntries[index].buttontext,\n    picture: createOptimizedPicture({\n      src: siteMapPostEntries[index].image,\n      alt: siteMapPostEntries[index].imagealt,\n      width: 323,\n      height: 199,\n    }),\n  };\n}\n\nexport default async function (block: HTMLElement) {\n  block.innerHTML = '';\n\n  const parser = new DOMParser();\n  try {\n    const queryIndex = await FetchService.fetchJson<SheetsResponse<SiteMapEntry>>('/query-index.json');\n    const siteMapPostEntries = queryIndex.data.filter((item) => item.path.startsWith('/posts'));\n    const postsPreview: (string | undefined)[] = await Promise.all(siteMapPostEntries.map((post) => fetchPost(post)));\n    const filteredPostPreview: string[] = postsPreview.filter((preview) => preview !== undefined) as string[];\n    const postsPreviewHtml = filteredPostPreview.map((res) => parser.parseFromString(res, 'text/html'));\n    const posts = postsPreviewHtml.map((doc, index) => createPostEntry(siteMapPostEntries, index, doc));\n\n    block.style.removeProperty('display');\n\n    const postsTemplate = await template(posts);\n\n    render(postsTemplate, block);\n  } catch (error) {\n    DebuggerService.error('Post Block: Error while fetching posts.', error);\n\n    const response = await PlaceholderService.getPlaceHolder('error');\n    const placeholderBlock = document.createElement('div');\n    const errorBlock = html`<article style=\"width: 100%\"><p>${response}</p></article>`;\n    render(errorBlock, placeholderBlock);\n\n    block.innerHTML = '';\n    block.appendChild(placeholderBlock);\n  }\n}\n"],"names":["renderHeadline","headline","html","nothing","renderText","text","renderPicture","postUrl","picture","ifDefined","postTemplate","args","buttontext","template","posts","placeholder","PlaceholderService","post","findFirstNonEmptyParagraph","doc","_a","p","fetchPost","FetchService","error","DebuggerService","createPostEntry","siteMapPostEntries","index","isSidekickLibraryActive","_b","createOptimizedPicture","block","parser","item","preview","res","postsTemplate","render","response","placeholderBlock","errorBlock"],"mappings":"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"}