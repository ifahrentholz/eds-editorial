{"version":3,"file":"posts.js","sources":["../../src/blocks/posts/posts.ts"],"sourcesContent":["import { html, nothing, render } from 'lit';\nimport { createOptimizedPicture } from '../../utils/createOptimizedPicture';\nimport FetchService from '../../services/fetch.service.ts';\nimport { SheetsResponse } from '../../shared.types.ts';\nimport './posts.scss';\nimport { DebuggerService } from '@kluntje/services';\nimport PlaceholderService from '../../services/placeholder.service.ts';\n\ninterface PostArgs {\n  postUrl: string;\n  headline?: string;\n  text?: string;\n  picture: HTMLPictureElement;\n  buttontext?: string;\n}\n\nconst renderHeadline = (headline?: string) => {\n  if (!headline) return nothing;\n  return html`<h3>${headline}</h3>`;\n};\n\nconst renderText = (text?: string) => {\n  if (!text) return nothing;\n  if (text.length > 200) {\n    return html`<p>${text.slice(0, 200)}...</p>`;\n  }\n  return html`<p>${text}</p>`;\n};\n\nconst postTemplate = (args: PostArgs) => {\n  const { postUrl, headline, text, picture, buttontext } = args;\n  return html`\n    <article>\n      <a href=\"${postUrl}\" class=\"image\">${picture}</a>\n      ${renderHeadline(headline)} ${renderText(text)}\n      <ul class=\"actions\">\n        <li><a href=\"${postUrl}\" class=\"button\">${buttontext || 'Goto Post'}</a></li>\n      </ul>\n    </article>\n  `;\n};\n\nconst template = (posts: PostArgs[]) => {\n  if (posts.length === 0) return html` <article>${PlaceholderService.getPlaceHolder('no posts')}</article> `;\n  return posts.map((post) => postTemplate(post));\n};\n\n// TODO: Candidate for a EDS helper function???\nconst findFirstNonEmptyParagraph = (doc: Document): string | undefined => {\n  const paragraphs = Array.from(doc.querySelectorAll('p'));\n  return paragraphs.find((p) => p.innerText.trim().length > 0)?.innerText;\n};\n\nexport default async function (block: HTMLElement) {\n  block.innerHTML = '';\n\n  const parser = new DOMParser();\n  try {\n    const queryIndex = await FetchService.fetchJson<SheetsResponse>('/query-index.json');\n    const siteMapPostEntries = queryIndex.data.filter((item) => item.path.includes('/posts'));\n\n    const postsPreview = await Promise.all(\n      siteMapPostEntries.map((post) =>\n        FetchService.fetchText(`${post.path}.plain.html`, {\n          cacheOptions: {\n            cacheType: 'runtime',\n          },\n        })\n      )\n    );\n\n    const postsPreviewHtml = postsPreview.map((res) => parser.parseFromString(res, 'text/html'));\n    const posts = postsPreviewHtml.map((doc, index) => {\n      return {\n        postUrl: `${window.hlx.codeBasePath}${siteMapPostEntries[index].path}`,\n        headline: doc.querySelector('h1')?.innerText || doc.querySelector('h2')?.innerText,\n        text: findFirstNonEmptyParagraph(doc),\n        buttontext: siteMapPostEntries[index].buttontext,\n        picture: createOptimizedPicture({\n          src: siteMapPostEntries[index].image,\n          alt: siteMapPostEntries[index].imagealt,\n          width: 323,\n          height: 199,\n        }),\n      };\n    });\n\n    block.style.removeProperty('display');\n    render(template(posts), block);\n  } catch (error) {\n    DebuggerService.error('Error');\n    const response = await PlaceholderService.getPlaceHolder('error');\n    const placeholderBlock = document.createElement('div');\n    render(html`<article style=\"width: 100%\"><p>${response}</p></article>`, placeholderBlock);\n    block.innerHTML = '';\n    block.appendChild(placeholderBlock);\n  }\n}\n"],"names":["renderHeadline","headline","html","nothing","renderText","text","postTemplate","args","postUrl","picture","buttontext","template","posts","PlaceholderService","post","findFirstNonEmptyParagraph","doc","_a","p","block","parser","siteMapPostEntries","FetchService","item","res","index","_b","createOptimizedPicture","render","DebuggerService","response","placeholderBlock"],"mappings":"kKAgBA,MAAMA,EAAkBC,GACjBA,EACEC,QAAWD,CAAQ,QADJE,EAIlBC,EAAcC,GACbA,EACDA,EAAK,OAAS,IACTH,OAAUG,EAAK,MAAM,EAAG,GAAG,CAAC,UAE9BH,OAAUG,CAAI,OAJHF,EAOdG,EAAgBC,GAAmB,CACvC,KAAM,CAAE,QAAAC,EAAS,SAAAP,EAAU,KAAAI,EAAM,QAAAI,EAAS,WAAAC,CAAe,EAAAH,EAClD,OAAAL,sBAEQM,CAAO,mBAAmBC,CAAO,QAC1CT,EAAeC,CAAQ,CAAC,IAAIG,EAAWC,CAAI,CAAC,oCAE7BG,CAAO,oBAAoBE,GAAc,WAAW,0BAI3E,EAEMC,EAAYC,GACZA,EAAM,SAAW,EAAUV,aAAiBW,EAAmB,eAAe,UAAU,CAAC,aACtFD,EAAM,IAAKE,GAASR,EAAaQ,CAAI,CAAC,EAIzCC,EAA8BC,GAAsC,OAEjE,OAAAC,EADY,MAAM,KAAKD,EAAI,iBAAiB,GAAG,CAAC,EACrC,KAAME,GAAMA,EAAE,UAAU,OAAO,OAAS,CAAC,IAApD,YAAAD,EAAuD,SAChE,EAEA,eAAAL,EAA+BO,EAAoB,CACjDA,EAAM,UAAY,GAEZ,MAAAC,EAAS,IAAI,UACf,GAAA,CAEI,MAAAC,GADa,MAAMC,EAAa,UAA0B,mBAAmB,GAC7C,KAAK,OAAQC,GAASA,EAAK,KAAK,SAAS,QAAQ,CAAC,EAalFX,GAXe,MAAM,QAAQ,IACjCS,EAAmB,IAAKP,GACtBQ,EAAa,UAAU,GAAGR,EAAK,IAAI,cAAe,CAChD,aAAc,CACZ,UAAW,SACb,CAAA,CACD,CACH,CAAA,GAGoC,IAAKU,GAAQJ,EAAO,gBAAgBI,EAAK,WAAW,CAAC,EAC5D,IAAI,CAACR,EAAKS,IAAU,SAC1C,MAAA,CACL,QAAS,GAAG,OAAO,IAAI,YAAY,GAAGJ,EAAmBI,CAAK,EAAE,IAAI,GACpE,WAAUR,EAAAD,EAAI,cAAc,IAAI,IAAtB,YAAAC,EAAyB,cAAaS,EAAAV,EAAI,cAAc,IAAI,IAAtB,YAAAU,EAAyB,WACzE,KAAMX,EAA2BC,CAAG,EACpC,WAAYK,EAAmBI,CAAK,EAAE,WACtC,QAASE,EAAuB,CAC9B,IAAKN,EAAmBI,CAAK,EAAE,MAC/B,IAAKJ,EAAmBI,CAAK,EAAE,SAC/B,MAAO,IACP,OAAQ,GAAA,CACT,CAAA,CACH,CACD,EAEKN,EAAA,MAAM,eAAe,SAAS,EAC7BS,EAAAjB,EAASC,CAAK,EAAGO,CAAK,OACf,CACdU,EAAgB,MAAM,OAAO,EAC7B,MAAMC,EAAW,MAAMjB,EAAmB,eAAe,OAAO,EAC1DkB,EAAmB,SAAS,cAAc,KAAK,EAC9CH,EAAA1B,mCAAuC4B,CAAQ,iBAAkBC,CAAgB,EACxFZ,EAAM,UAAY,GAClBA,EAAM,YAAYY,CAAgB,CACpC,CACF"}